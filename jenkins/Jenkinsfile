pipeline {
    environment {
      pod_automation_home = "${WORKSPACE}"
      aws_username = "$vi_username"
      aws_password = "$vi_password"
    }



    agent any
    parameters {
      choice choices: ['default', 'spinvm', 'baseImage', 'configuration'], description: '', name: 'Stage'
    }


    stages{

      stage('spinvm') {
        when {
            expression { params.Stage == "default" || params.Stage == "spinvm" }
           }
          steps {
      
            dir ('terraform/aws') {
            withEnv (["TF_VAR_aws_username=$vi_username", "TF_VAR_aws_password=$vi_password"]) {
             sh 'terraform validate --var-file=environment/compute/amazonaws/com/variables.tfvars'
             sh 'terraform apply --var-file=environment/compute/amazonaws/com/variables.tfvars terraform/aws/main.tf --state=/aws/terraform.tfstate'
             sh 'terraform output -state=/aws/app/terraform.tfstate host_ip | tr -d ',' > $pod_automation_home/ansible/hosts'
            }
           }
         }
      }
    }
}
